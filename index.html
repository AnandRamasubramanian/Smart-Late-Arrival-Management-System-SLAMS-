<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>SLAMS - Late Entry System</title>
  <style>
    body {
      font-family: "Segoe UI", Arial, sans-serif;
      padding: 20px;
      max-width: 900px;
      margin: 0 auto;
      background: linear-gradient(135deg, #f0f4ff, #dbe6f6);
    }
    h1 {
      text-align: center;
      font-size: 32px;
      color: #2c3e50;
    }
    h2 {
      margin-top: 20px;
      color: #2c3e50;
      text-align: center;
    }
    a {
      display: block;
      margin-top: 10px;
      color: #0078d7;
      cursor: pointer;
      text-decoration: underline;
    }
    form, #dashboard, #lateComersSection {
      background: #fff;
      padding: 20px;
      border-radius: 16px;
      box-shadow: 0 8px 20px rgba(0,0,0,0.1);
      margin-top: 20px;
    }
    label {
      font-weight: 600;
      margin-top: 10px;
      display: block;
    }
    input, select, button {
      width: 100%;
      padding: 10px;
      margin-top: 6px;
      border-radius: 8px;
      border: 1px solid #ccc;
      font-size: 14px;
    }
    button {
      background: #0078d7;
      color: #fff;
      border: none;
      cursor: pointer;
      font-weight: bold;
      margin-top: 12px;
    }
    button:hover {
      background: #005a9e;
    }
    table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 20px;
      font-size: 14px;
    }
    th, td {
      border: 1px solid #ccc;
      padding: 8px;
      text-align: center;
    }
    th {
      background: #f4f4f4;
    }
  </style>
</head>
<body>
  <!-- Header with logo and title -->
  <header>
<h1>Chinmaya Vidyalaya<br> Senior Secondary School<br> </h1>
    <h3>Virugambakkam, Chennai-92.<h3>
    <h2>Smart Late Arrival Management System (SLAMS)</h2></header>
<!-- Form -->
  <h2>Late Entry Form</h2>
  <a onclick="showLateComersForm()">ðŸ“‹ View Late Comers List</a>

  <form id="lateForm">
    <label for="admissionNo">Admission No</label>
    <input id="admissionNo" required />

    <label for="name">Name</label>
    <input id="name" required />

    <label for="class">Class</label>
    <input id="class" placeholder="e.g., 1A" required />

    <label for="section">Section</label>
    <input id="section" required />

    <label for="rollNo">Roll No</label>
    <input id="rollNo" required />

    <label for="time">Time</label>
    <input id="time" type="time" required />

    <label for="date">Date</label>
    <input id="date" type="date" required />

    <label for="reason">Reason</label>
    <select id="reason" required>
      <option value="">-- Select Reason --</option>
      <option value="Traffic">Traffic</option>
      <option value="Overslept">Overslept</option>
      <option value="Transport Delay">Transport Delay</option>
      <option value="Health Issue">Health Issue</option>
      <option value="Other">Other</option>
    </select>

    <button type="submit" id="submitBtn">Submit</button>
  </form>

  <div id="dashboard">
    <h2>Dashboard - Late Entries</h2>
    <button onclick="loadData()">ðŸ”„ Refresh Data</button>
    <div id="dataTableContainer"></div>
  </div>

  <div id="lateComersSection" style="display:none;">
    <h2>Late Comers List</h2>
    <label for="filterDate">Select Date</label>
    <input type="date" id="filterDate" required />

    <label for="filterClass">Select Class (optional)</label>
    <input type="text" id="filterClass" placeholder="e.g., 1A" />

    <button onclick="fetchLateComers()">Show List</button>
    <div id="lateComersList"></div>
  </div>
  <script>
    const WEB_APP_URL = "https://script.google.com/macros/s/AKfycbwSCZ3f8gt5cKq4dwg3vedSTMEM5KR1GKst_dz9sY9ri9IhR8EB1kJarqZWkt-8_rx9WA/exec";
function autoFillDateTime() {
      const now = new Date();
      document.getElementById("date").value = now.toISOString().split("T")[0];
      document.getElementById("time").value = now.toTimeString().slice(0,5);
    }

    function showLateComersForm() {
      document.getElementById("lateComersSection").style.display = "block";
    }

    function formatDateTime(dateTimeStr) {
      const dt = new Date(dateTimeStr);
      return dt.toLocaleString('en-IN', { weekday:"long", year:"numeric", month:"short", day:"numeric", hour:"numeric", minute:"numeric", hour12:true });
    }

    document.getElementById("lateForm").addEventListener("submit", async function(e){
      e.preventDefault();
      const submitBtn = document.getElementById("submitBtn");
      submitBtn.disabled = true;

      const payload = {
        admissionNo: document.getElementById("admissionNo").value.trim(),
        name: document.getElementById("name").value.trim(),
        class: document.getElementById("class").value.trim(),
        section: document.getElementById("section").value.trim(),
        rollNo: document.getElementById("rollNo").value.trim(),
        time: document.getElementById("time").value,
        date: document.getElementById("date").value,
        reason: document.getElementById("reason").value.trim()
      };

      try {
        const res = await fetch(WEB_APP_URL, {
          method: "POST",
          body: JSON.stringify(payload)
        });
        const json = await res.json();

        if (json.status === "success") {
          alert("Submitted âœ”");
          document.getElementById("lateForm").reset();
          autoFillDateTime();
          loadData();
        } else {
          alert("Server error: " + json.message);
        }
      } catch (err) {
        alert("Error: " + err);
      } finally {
        submitBtn.disabled = false;
      }
    });

    async function loadData() {
      try {
        const res = await fetch(WEB_APP_URL);
        const data = await res.json();
        const container = document.getElementById("dataTableContainer");
        container.innerHTML = "";

        if (data.length > 0) {
          const grouped = {};
          data.forEach(row => {
            if (!grouped[row.admissionNo]) grouped[row.admissionNo] = [];
            grouped[row.admissionNo].push({
              dateTime: row.dateTime,
              reason: row.reason
            });
          });

          Object.entries(grouped).forEach(([admissionNo, records]) => {
            const header = document.createElement("h3");
            header.textContent = `Admission No: ${admissionNo} â€” Total Late Count: ${records.length}`;
            container.appendChild(header);

            const table = document.createElement("table");
            table.innerHTML = `<thead><tr><th>Date & Time</th><th>Reason</th></tr><tbody></tbody></thead>`;
            const tbody = table.querySelector("tbody");

            records.forEach(r => {
              const tr = document.createElement("tr");
              tr.innerHTML = `<td>${formatDateTime(r.dateTime)}</td><td>${r.reason}</td>`;
              tbody.appendChild(tr);
            });

            container.appendChild(table);
          });
        } else {
          container.innerHTML = "<p>No records found</p>";
        }
      } catch (err) {
        alert("Error: " + err);
      }
    }

    async function fetchLateComers() {
      const filterDate = document.getElementById("filterDate").value;
      const filterClass = document.getElementById("filterClass").value.trim();

      if (!filterDate) {
        alert("Please select a date.");
        return;
      }

      try {
        const res = await fetch(`${WEB_APP_URL}?action=lateComers&date=${filterDate}&class=${encodeURIComponent(filterClass)}`);
        const data = await res.json();
        const container = document.getElementById("lateComersList");
        container.innerHTML = "";

        if (data.length > 0) {
          const table = document.createElement("table");
          table.innerHTML = `
            <thead><tr><th>Name</th><th>Class</th><th>Section</th><th>Roll No</th><th>Admission No</th><th>Reason</th></tr></thead>
            <tbody></tbody>
          `;
          const tbody = table.querySelector("tbody");

          data.forEach(row => {
            const tr = document.createElement("tr");
            tr.innerHTML = `
              <td>${row.name}</td>
              <td>${row.class}</td>
              <td>${row.section}</td>
              <td>${row.rollNo}</td>
              <td>${row.admissionNo}</td>
              <td>${row.reason}</td>
            `;
            tbody.appendChild(tr);
          });

          container.appendChild(table);
        } else {
          container.innerHTML = "<p>No late comers found for this date.</p>";
        }
      } catch (err) {
        alert("Error: " + err);
      }
    }

    window.onload = function() {
      autoFillDateTime();
      loadData();
    };
  <header>
  <img src="https://cvvlatemanagementsystem-hash.github.io/Chinmaya-Vidyalaya-Smart-Late-Arrival-Management-System-SLAMS-/Chinmaya%20Computing%20Club%20Logo%20(2).png" height=100 width=100 alt="Chinmaya Computing Club Logo">
<h5>Powered by R Anand from Chinmaya Computing Club</h5><br>
<h5>Developed by R Anand</h5> <br>
      <h5>Mentored by Aishwarya Bramma</h5> <br>
      <h5>Guided by Principal Elavarasi Mam</h5></header>
</body>
</html>
